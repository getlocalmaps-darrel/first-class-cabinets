---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import MainLayout from '../../layouts/MainLayout.astro';
import AuthorBio from '../../components/AuthorBio.astro';

// Client photos for article imagery
import heroKitchen from '../../assets/hero-kitchen.jpg';
import kitchen2 from '../../assets/kitchen-2.jpg';
import projectPhoto from '../../assets/murrieta-kitchen-remodeling-project-1.jpg';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => {
    const slug = post.id.replace(/\.mdx?$/, '');
    return {
      params: { slug },
      props: { post, slug },
    };
  });
}

const { post, slug } = Astro.props;
const { Content, headings } = await post.render();
const { title, description, publishDate, lastUpdated, author, authorTitle, category, tags, readingTime, faqSchema, relatedSlugs } = post.data;
const dateStr = new Date(publishDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
const isoDate = new Date(publishDate).toISOString();
const lastUpdatedStr = lastUpdated ? new Date(lastUpdated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : null;
const isoUpdated = lastUpdated ? new Date(lastUpdated).toISOString() : isoDate;

// TOC — only H2 headings for clean navigation
const tocItems = headings.filter(h => h.depth === 2);

// Related posts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = relatedSlugs.length > 0
  ? allPosts.filter(p => relatedSlugs.includes(p.id.replace(/\.mdx?$/, '')))
  : [];

// Share URLs
const articleUrl = `https://www.firstclasswoodworks.com/blog/${slug}/`;
const encodedUrl = encodeURIComponent(articleUrl);
const encodedTitle = encodeURIComponent(title);

// Article JSON-LD
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": "https://www.firstclasswoodworks.com/assets/hero-kitchen.jpg",
  "datePublished": isoDate,
  "dateModified": isoUpdated,
  "author": {
    "@type": "Person",
    "name": author,
    "jobTitle": authorTitle,
    "url": "https://www.firstclasswoodworks.com/blog/author/"
  },
  "publisher": {
    "@type": "LocalBusiness",
    "@id": "https://www.firstclasswoodworks.com/#business",
    "name": "First Class WoodWorks",
    "telephone": "(951) 973-1265",
    "url": "https://www.firstclasswoodworks.com",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "24491 Avenida Arconte",
      "addressLocality": "Murrieta",
      "addressRegion": "CA",
      "postalCode": "92562"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": articleUrl
  },
  "speakable": {
    "@type": "SpeakableSpecification",
    "cssSelector": [".speakable-answer", "h1", ".key-takeaways"]
  }
};

// FAQPage schema
const faqPageSchema = faqSchema.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqSchema.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": { "@type": "Answer", "text": faq.answer }
  }))
} : null;

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://www.firstclasswoodworks.com/" },
    { "@type": "ListItem", "position": 2, "name": "Blog", "item": "https://www.firstclasswoodworks.com/blog/" },
    { "@type": "ListItem", "position": 3, "name": title, "item": articleUrl }
  ]
};
---

<MainLayout title={title} description={description}>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  {faqPageSchema && <script type="application/ld+json" set:html={JSON.stringify(faqPageSchema)} />}
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <article class="pb-20 bg-white">
    <!-- Hero Banner -->
    <div class="relative bg-zinc-900 -mt-[180px] pt-[200px] md:pt-[220px] pb-16 mb-12 overflow-hidden">
      <Image src={heroKitchen} alt={title} class="absolute inset-0 w-full h-full object-cover opacity-20" width={1200} height={600} />
      <div class="relative max-w-6xl mx-auto px-6">
        <!-- Breadcrumb -->
        <nav class="mb-8">
          <ol class="flex items-center gap-2 text-xs text-white/50">
            <li><a href="/" class="hover:text-yellow-600 transition">Home</a></li>
            <li>/</li>
            <li><a href="/blog/" class="hover:text-yellow-600 transition">Blog</a></li>
            <li>/</li>
            <li class="text-white/70 truncate max-w-[250px]">{title}</li>
          </ol>
        </nav>

        <div class="flex items-center gap-3 mb-5">
          <span class="text-[10px] font-bold uppercase tracking-[0.15em] text-zinc-900 bg-yellow-600 px-3 py-1 rounded-sm">{category}</span>
          <span class="text-[10px] text-white/50 uppercase tracking-widest">{readingTime} read</span>
        </div>
        <h1 class="font-serif text-3xl md:text-5xl lg:text-6xl font-bold text-white leading-tight mb-6 max-w-4xl">{title}</h1>
        <p class="text-white/60 text-lg max-w-2xl leading-relaxed mb-8">{description}</p>
        <div class="flex items-center gap-4">
          <img src="/assets/author-diego.svg" alt={author} class="w-10 h-10 rounded-full border-2 border-yellow-600" />
          <div>
            <a href="/blog/author/" class="text-white font-bold text-sm hover:text-yellow-600 transition">{author}</a>
            <div class="text-white/40 text-xs">
              <time datetime={isoDate}>{dateStr}</time>
              {lastUpdatedStr && (
                <span> &bull; Updated <time datetime={isoUpdated}>{lastUpdatedStr}</time></span>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-6xl mx-auto px-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-16">

        <!-- Main Content -->
        <div class="lg:col-span-8">
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-8">
              {tags.map(tag => (
                <span class="text-[10px] text-zinc-500 bg-zinc-100 px-2.5 py-1 rounded-sm uppercase tracking-widest border border-zinc-200">{tag}</span>
              ))}
            </div>
          )}

          <!-- Table of Contents -->
          {tocItems.length > 2 && (
            <nav class="toc-box mb-10" id="toc">
              <button class="toc-toggle" id="toc-toggle" aria-expanded="true" aria-controls="toc-list">
                <span class="toc-title">Table of Contents</span>
                <svg class="toc-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <ol class="toc-list" id="toc-list">
                {tocItems.map((heading, i) => (
                  <li>
                    <a href={`#${heading.slug}`} class="toc-link">
                      <span class="toc-number">{i + 1}</span>
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ol>
            </nav>
          )}

          <!-- Article Body — no .reveal here, content must be visible immediately -->
          <div class="article-content">
            <Content />
          </div>

          <!-- Social Sharing -->
          <div class="share-box mt-12 reveal">
            <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-zinc-400 mb-4">Share This Article</p>
            <div class="flex items-center gap-3">
              <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on Facebook">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              </a>
              <a href={`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on X">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </a>
              <a href={`https://pinterest.com/pin/create/button/?url=${encodedUrl}&description=${encodedTitle}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on Pinterest">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738a.36.36 0 01.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.631-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24 12.017 24c6.624 0 11.99-5.367 11.99-11.988C24.007 5.367 18.641 0 12.017 0z"/></svg>
              </a>
              <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`} target="_blank" rel="noopener noreferrer" class="share-btn" aria-label="Share on LinkedIn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
              </a>
              <button class="share-btn" id="copy-link-btn" aria-label="Copy link">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
              </button>
            </div>
          </div>

          <!-- Project Photo -->
          <div class="mt-12 reveal">
            <Image src={projectPhoto} alt="Custom kitchen remodeling project by First Class WoodWorks in Murrieta" class="w-full rounded-sm shadow-lg" width={800} height={500} />
            <p class="text-xs text-zinc-400 mt-2 text-center">Recent custom kitchen project by First Class WoodWorks in Murrieta, CA</p>
          </div>

          <!-- Related Articles -->
          {relatedPosts.length > 0 && (
            <section class="mt-16 reveal">
              <h2 class="font-serif text-2xl font-bold text-zinc-900 mb-6">Related Articles</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {relatedPosts.map(rp => (
                  <a href={`/blog/${rp.id.replace(/\.mdx?$/, '')}/`} class="group block bg-zinc-50 border border-zinc-200 rounded-sm p-5 hover:shadow-lg transition-all duration-300">
                    <span class="text-[10px] font-bold uppercase tracking-[0.15em] text-yellow-600">{rp.data.category}</span>
                    <h3 class="font-serif text-lg font-bold text-zinc-900 group-hover:text-yellow-600 transition mt-1">{rp.data.title}</h3>
                    <p class="text-sm text-zinc-500 mt-2 line-clamp-2">{rp.data.description}</p>
                  </a>
                ))}
              </div>
            </section>
          )}

          <!-- Author Bio -->
          <AuthorBio name={author} title={authorTitle} />
        </div>

        <!-- Sticky Sidebar -->
        <aside class="lg:col-span-4 space-y-8">
          <div class="sticky top-28 space-y-8">

            <!-- CTA Box -->
            <div class="bg-zinc-900 text-white p-8 rounded-sm reveal">
              <h3 class="font-serif font-bold text-xl mb-2 text-yellow-600">Ready to Build?</h3>
              <p class="text-zinc-400 text-sm leading-relaxed mb-6">
                Get a free consultation with 3D renderings for your custom cabinetry project. We serve Murrieta, Temecula & the entire Inland Empire.
              </p>
              <a href="tel:9519731265" class="block text-center border border-yellow-600 py-3.5 font-bold text-sm uppercase tracking-wider hover:bg-yellow-600 hover:text-zinc-900 transition mb-3">
                (951) 973-1265
              </a>
              <a href="/contact" class="block text-center bg-yellow-600 text-zinc-900 py-3.5 font-bold text-sm uppercase tracking-wider hover:bg-yellow-700 transition rounded-sm">
                Get Free Quote
              </a>
            </div>

            <!-- Why First Class Box -->
            <div class="bg-zinc-50 border border-zinc-200 p-6 rounded-sm reveal">
              <h4 class="font-serif font-bold text-zinc-900 mb-4">Why First Class WoodWorks</h4>
              <ul class="space-y-3 text-sm text-zinc-600">
                <li class="flex items-start gap-2">
                  <span class="text-yellow-600 font-bold mt-0.5">&#10003;</span>
                  <span>100% in-house — no subcontractors</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-yellow-600 font-bold mt-0.5">&#10003;</span>
                  <span>Furniture-grade plywood & solid hardwoods</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-yellow-600 font-bold mt-0.5">&#10003;</span>
                  <span>Blum soft-close hardware (lifetime warranty)</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-yellow-600 font-bold mt-0.5">&#10003;</span>
                  <span>3D renderings before fabrication</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="text-yellow-600 font-bold mt-0.5">&#10003;</span>
                  <span>CA License #1103734</span>
                </li>
              </ul>
            </div>

            <!-- Sidebar Photo -->
            <div class="rounded-sm overflow-hidden shadow-lg reveal">
              <Image src={kitchen2} alt="Custom kitchen cabinets by First Class WoodWorks" class="w-full" width={400} height={300} />
            </div>

            <!-- Trust Badges -->
            <div class="flex items-center justify-between py-4 border-y border-zinc-200 reveal">
              <div class="text-center">
                <span class="text-zinc-900 font-bold text-lg block">5.0</span>
                <span class="text-[9px] text-zinc-500 uppercase tracking-widest">Rating</span>
              </div>
              <div class="h-8 w-px bg-zinc-200"></div>
              <div class="text-center">
                <span class="text-zinc-900 font-bold text-lg block">A+</span>
                <span class="text-[9px] text-zinc-500 uppercase tracking-widest">BBB</span>
              </div>
              <div class="h-8 w-px bg-zinc-200"></div>
              <div class="text-center">
                <span class="text-zinc-900 font-bold text-lg block">10+</span>
                <span class="text-[9px] text-zinc-500 uppercase tracking-widest">Years</span>
              </div>
            </div>

          </div>
        </aside>

      </div>
    </div>
  </article>

  <!-- TOC toggle + Copy link scripts -->
  <script>
    // TOC collapse/expand
    const toggle = document.getElementById('toc-toggle');
    const list = document.getElementById('toc-list');
    if (toggle && list) {
      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!expanded));
        list.style.display = expanded ? 'none' : 'block';
        toggle.querySelector('.toc-chevron')?.classList.toggle('rotate-180', expanded);
      });
    }

    // Copy link button
    const copyBtn = document.getElementById('copy-link-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          copyBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
          setTimeout(() => {
            copyBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
          }, 2000);
        } catch {}
      });
    }
  </script>
</MainLayout>

<style is:global>
  /* ==========================================
     TABLE OF CONTENTS
     ========================================== */
  .toc-box {
    background: #fafafa;
    border: 1px solid #e4e4e7;
    border-radius: 4px;
    overflow: hidden;
  }
  .toc-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: none;
    border: none;
    cursor: pointer;
  }
  .toc-title {
    font-family: var(--font-serif);
    font-weight: 700;
    font-size: 0.95rem;
    color: #18181b;
    letter-spacing: 0.01em;
  }
  .toc-chevron {
    color: #71717a;
    transition: transform 0.2s;
  }
  .toc-chevron.rotate-180 {
    transform: rotate(180deg);
  }
  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0 1.25rem 1rem;
    counter-reset: none;
  }
  .toc-list li {
    margin: 0;
    border-top: 1px solid #f4f4f5;
  }
  .toc-link {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    padding: 0.6rem 0;
    font-size: 0.875rem;
    color: #52525b !important;
    text-decoration: none !important;
    border-bottom: none !important;
    transition: color 0.15s;
  }
  .toc-link:hover {
    color: #ca8a04 !important;
  }
  .toc-number {
    font-size: 0.7rem;
    font-weight: 700;
    color: #ca8a04;
    min-width: 1.25rem;
  }

  /* ==========================================
     SOCIAL SHARING
     ========================================== */
  .share-box {
    padding-top: 1.5rem;
    border-top: 1px solid #f4f4f5;
  }
  .share-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #f4f4f5;
    color: #52525b;
    border: 1px solid #e4e4e7;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none !important;
  }
  .share-btn:hover {
    background: #ca8a04;
    color: #fff;
    border-color: #ca8a04;
  }

  /* ==========================================
     ARTICLE CONTENT — matches service page aesthetic
     ========================================== */
  .article-content h2 {
    font-family: var(--font-serif);
    font-size: 1.75rem;
    font-weight: 700;
    color: #18181b;
    margin-top: 3rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #f4f4f5;
  }
  .article-content h3 {
    font-family: var(--font-serif);
    font-size: 1.25rem;
    font-weight: 700;
    color: #18181b;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }
  .article-content p {
    color: #52525b;
    font-size: 1.0625rem;
    line-height: 1.85;
    margin-bottom: 1.25rem;
  }
  .article-content a {
    color: #ca8a04;
    font-weight: 600;
    text-decoration: none;
    border-bottom: 1px solid rgba(202, 138, 4, 0.3);
    transition: border-color 0.2s;
  }
  .article-content a:hover {
    border-bottom-color: #ca8a04;
  }
  .article-content strong {
    color: #27272a;
    font-weight: 700;
  }
  .article-content ul, .article-content ol {
    margin: 0 0 1.5rem 1.5rem;
    color: #52525b;
  }
  .article-content li {
    margin-bottom: 0.5rem;
    line-height: 1.75;
    font-size: 1.0625rem;
  }
  /* Key Takeaways box */
  .article-content h2:first-of-type + ul,
  .article-content h2:first-child + ul {
    background: rgba(234, 179, 8, 0.05);
    border-left: 4px solid #eab308;
    padding: 1.25rem 1.5rem;
    border-radius: 0 4px 4px 0;
    margin-left: 0;
    list-style: none;
  }
  .article-content h2:first-of-type + ul li,
  .article-content h2:first-child + ul li {
    padding-left: 1.5rem;
    position: relative;
  }
  .article-content h2:first-of-type + ul li::before,
  .article-content h2:first-child + ul li::before {
    content: "\2713";
    position: absolute;
    left: 0;
    color: #eab308;
    font-weight: 700;
  }
  /* Pro Tip / Blockquotes */
  .article-content blockquote {
    background: #fafafa;
    border-left: 4px solid #eab308;
    padding: 1.25rem 1.5rem;
    border-radius: 0 4px 4px 0;
    margin: 2rem 0;
    font-style: normal;
  }
  .article-content blockquote p {
    color: #3f3f46;
    margin-bottom: 0;
  }
  /* FAQ section */
  .article-content h2 + h3 {
    background: #fafafa;
    margin: 0;
    padding: 1rem 1.25rem 0;
    border-radius: 4px 4px 0 0;
    border: 1px solid #f4f4f5;
    border-bottom: none;
  }
  .article-content h3 + p {
    margin-top: 0;
  }
</style>
